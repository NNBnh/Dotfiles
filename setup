#!/bin/sh

#    ____    __
#   / __/__ / /___ _____
#  _\ \/ -_) __/ // / _ \
# /___/\__/\__/\_,_/ .__/
#                 /_/

# File:         setup
# Description:  setup script that SuperB
# Author:       NNB
#               └─ https://github.com/NNBnh
# URL:          https://github.com/NNBnh/dots/blob/master/setup


# Values
DOTS=$(cd -P -- "$(dirname -- "$0")" && pwd -P)

. "$DOTS/home/.config/env"

BAWKPACK_PATH="$DOTS/home/.local/bin/bawkpack"
BSYMLINK_PATH="$DOTS/home/.local/bin/bsymlink"

STEPS="${*:-install extra before home root after}"


# Functions
install_packages() {
	"$BAWKPACK_PATH" "$DOTS/packageslist"
}

install_packages_extra() {
	# Python packages
	pip install --upgrade 'auto-editor' 'git+https://github.com/will8211/unimatrix.git'

	# Basher packages
	git clone 'https://github.com/basherpm/basher.git' "$XDG_DATA_HOME/basher" \
	&& ln -sf "$XDG_DATA_HOME/basher/bin/basher" "$HOME/.local/bin/"

	basher install 'NNBnh/bui-terminal'
	basher install 'NNBnh/bfetch'
	basher install 'NNBnh/terminal-explorer'
	basher install 'NNBnh/coderun'
	basher install 'NNBnh/clipb'

	# Fetchutils
	git clone 'https://github.com/lptstr/fetchutils.git' "$XDG_DATA_HOME/fetchutils"

	# Git alias
	curl -fsSL 'https://raw.githubusercontent.com/GitAlias/gitalias/master/gitalias.txt' --create-dirs --output "$XDG_DATA_HOME/git/gitalias.txt"

	# MPV
	mkdir -p "$XDG_CONFIG_HOME/mpv/scripts"
	curl -fsSL 'https://raw.githubusercontent.com/occivink/mpv-image-viewer/master/scripts/detect-image.lua'      > "$XDG_CONFIG_HOME/mpv/scripts/detect-image.lua"
	curl -fsSL 'https://raw.githubusercontent.com/occivink/mpv-image-viewer/master/scripts/freeze-window.lua'     > "$XDG_CONFIG_HOME/mpv/scripts/freeze-window.lua"
	curl -fsSL 'https://raw.githubusercontent.com/occivink/mpv-image-viewer/master/scripts/image-positioning.lua' > "$XDG_CONFIG_HOME/mpv/scripts/image-positioning.lua"
	curl -fsSL 'https://raw.githubusercontent.com/occivink/mpv-image-viewer/master/scripts/ruler.lua'             > "$XDG_CONFIG_HOME/mpv/scripts/ruler.lua"

	# Resource
		# Textarts
		git clone 'https://github.com/NNBnh/textart-collections.git' "$XDG_DATA_HOME/textarts"

		# Figlet fonts
		git clone 'https://github.com/xero/figlet-fonts.git' "$XDG_DATA_HOME/figlet/fonts"

		# Mono fonts
		aria2c --dir "$TMPDIR" $(curl --silent --location 'https://api.github.com/repos/NNBnh/bmono/releases/latest' | grep -e '/bmono-ttf.zip' | cut -f '4' -d '"') \
		&& 7z x -o"$TMPDIR/" "$TMPDIR/bmono-ttf.zip" \
		&& mv "$TMPDIR/ttf/"* "$XDG_DATA_HOME/fonts/"

		# Wallpapers
		git clone 'https://github.com/NNBnh/wallpaper-collections.git' "$XDG_DATA_HOME/wallpapers"

		# Mouse cursor
		aria2c --dir "$TMPDIR" 'https://github.com/ful1e5/Bibata_Cursor/releases/download/v1.0.3/Bibata-Original-Ice.tar.gz' \
		&& 7z x -o"$TMPDIR/" "$TMPDIR/Bibata-Original-Ice.tar.gz" \
		&& 7z x -o"$TMPDIR/" "$TMPDIR/Bibata-Original-Ice.tar" \
		&& mv "$TMPDIR/Bibata-Original-Ice" "$XDG_DATA_HOME/icons/"

		# Charater picker
		mkdir -p "$XDG_DATA_HOME/charaters"
		curl -fsSL 'https://www.unicode.org/Public/emoji/13.1/emoji-test.txt' \
		| sed -e 's/ E[0-9.]*/:/g' -ne 's/^.*fully-qualified *# //p' > "$XDG_DATA_HOME/charaters/emoji"
		curl -fsSL 'https://raw.githubusercontent.com/carloscuesta/gitmoji/master/src/data/gitmojis.json' \
		| jq --raw-output '.gitmojis[] | [.emoji, .description] | join(": ")' > "$XDG_DATA_HOME/charaters/gitmoji"

	# Adblock
	curl -fsSL 'https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts' --create-dirs --output "$TMPDIR/hosts" \
	&& printf '%s' "127.0.1.1 $(hostname)" >> "$TMPDIR/hosts" \
	&& sudo mv "$TMPDIR/hosts" '/etc/hosts'
}

symlink_home() {
	"$BSYMLINK_PATH" "$DOTS/home" "$HOME"
}

symlink_root() {
	sudo "$BSYMLINK_PATH" "$DOTS/root" '/'
}

before_symlink() {
	# Remove junks (Spring cleaning your $HOME)
	mkdir "$XDG_DESKTOP_DIR"
	trash "$HOME/Desktop" "$HOME/Documents" "$HOME/Downloads" "$HOME/Music" "$HOME/Pictures" "$HOME/Public" "$HOME/Templates" "$HOME/Videos" \
	      "$HOME/.inputrc" "$HOME/.xinitrc" "$HOME/.xsession" "$HOME/.xsession-errors" \
	      "$HOME/.Xclients" "$HOME/.profile" "$HOME/.dmrc" "$HOME/.ICEauthority" "$HOME/.icons" \
	      "$HOME/.bashrc" "$HOME/.bash_profile" "$HOME/.bash_history" "$HOME/.bash_logout" 2>&-

	for config_directory_path in "$XDG_CONFIG_HOME/."* "$XDG_CONFIG_HOME/"*; do
		config_directory_name="${config_directory_path#$XDG_CONFIG_HOME/}"

		if [ "$config_directory_name" != '.' ] && [ "$config_directory_name" != '..' ] && [ -e "$HOME/dots/home/.config/$config_directory_name" ]; then
			mv "$config_directory_path" "$XDG_DESKTOP_DIR/"
		fi
	done

	# Create directories (to only symlink files inside, not the directory)
	mkdir -p "$XDG_CONFIG_HOME/fcitx" "$XDG_CONFIG_HOME/kak" "$XDG_CONFIG_HOME/retroarch" \
	         "$XDG_DATA_HOME/fonts" "$XDG_DATA_HOME/icons" "$XDG_DATA_HOME/charaters" \
	         "$XDG_CACHE_HOME" \
	         "$HOME/.local/bin"

	# Adblock
	printf "$(< /etc/lightdm/lightdm.conf)\n\n[LightDM]\nuser-authority-in-system-dir=true" >> "$TMPDIR/lightdm.conf" \
	&& sudo mv "$TMPDIR/lightdm.conf" '/etc/lightdm/lightdm.conf'
}

after_symlink() {
	# Change default shell
	chsh --shell '/usr/bin/fish'

	# Change XDG directories
	for xdg_directory in 'DESKTOP' 'DOCUMENTS' 'DOWNLOAD' 'MUSIC' 'PICTURES' 'PUBLICSHARE' 'TEMPLATES' 'VIDEOS'; do
		eval "xdg-user-dirs-update --set '$xdg_directory' \"\$XDG_${xdg_directory}_DIR\""
	done

	# Firefox CSS
	for profile in "$HOME/.mozilla/firefox/"*".default-release"; do
		ln -fs "$DOTS/extra/firefox/chrome" "$profile/"
	done \
	&& echo 'Remember to enable the option toolkit.legacyUserProfileCustomizations.stylesheets in about:config'

	# Enable firewall
	sudo ufw enable
}

# Start
for step in $STEPS; do
	case "$step" in
		'i'|'install') install_packages       ;;
		'e'|'extra')   install_packages_extra ;;
		'b'|'before')  before_symlink         ;;
		'h'|'home')    symlink_home           ;;
		'r'|'root')    symlink_root           ;;
		'a'|'after')   after_symlink          ;;
		*)             exit 1                 ;;
	esac
done


exit 0
