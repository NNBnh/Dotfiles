#!/bin/sh

time_now="$(date +%d-%m-%Y_%H-%M-%S_%N)"

function screenshot() {
	maim -u "$HOME/Desktop/$time_now.png"
	snview
}

function screencrop() {
	maim -u -s "$HOME/Desktop/$time_now.png"
	snview
}

function snview() {
	act=$(dunstify -b "Screeny" --action="view,View" "$time_now.png")
	case $act in
		"view")
    		pix "$HOME/Desktop/$time_now.png"
    		;;
	esac
}

function record() {
	stoprecord || countdown
}

function quickrecord() {
	stoprecord || startrecord
}

function stoprecord() {
	killall ffmpeg && \
	dunstify -b "Screeny" "Stop recording"
}

function countdown() {
	for count in 'Start in 3' 'Start in 2' 'Start in 1' 'REC'
	do
		sleep 1
		dunstify -r 766676 -b "Screeny" "$count" &
	done

	startrecord
}

function startrecord() {
	ffmpeg -f x11grab \
		-s 1366x768 \
		-an -i :0.0 \
		-c:v libvpx \
		-b:v 5M \
		-crf 10 \
		-quality realtime \
		-y "$HOME/Desktop/$time_now.mkv"
}

flag="${1:-"full"}"

case $flag in
	"full") screenshot ;;
	"crop") screencrop ;;
	"record") record ;;
	"quick") quickrecord ;;
	"menu")
		theme="-theme themes/noscroll.rasi"

		# Options
		reco=" Record"
		full=" Screenshot"
		crop=" Screencrop"

		options="$reco\n$full\n$crop"

		chosen="$(echo -e "$options" | rofi $theme -p "Screeny" -dmenu -i -lines 3 -width 12)"
		case $chosen in
			$reco) record ;;
			$full) screenshot ;;
			$crop) screencrop ;;
		esac
		;;
esac

exit 0
