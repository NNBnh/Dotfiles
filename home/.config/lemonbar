#!/bin/sh


pading='----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------'

bar_max=136
tab_max=24
ffg='#FF1C1B19'
fbg='#FFFED06E'
nfg='#FFD0BFA1'
nbg='#001C1B19'

date=$(date +"%I:%M")
other="%{F$3}$date%{F#00000000}${pading::1}"

workspaces_list=($(bspc query -D -d .occupied -m focused --names))
workspace_focus=$(bspc query -D -d .occupied.focused --names)
for workspace_id in ${workspaces_list[@]}; do
	workspace=$workspace_id
	if [[ $workspace_id == $workspace_focus ]]; then
		fg=$ffg
		bg=$fbg
	else
		fg=$nfg
		bg=$nbg
	fi
	workspaces+="%{A1:bspc desktop -f $workspace_id: F$fg B$bg} $workspace %{F$nfg B$nbg A A A}"
	workspaces_length=$(( $workspaces_length + ${#workspace} + 2 ))
done
workspaces+="%{F#00000000}${pading::2}"

tabs_max=$(( $bar_max - ( $workspaces_length + ${#date} + 6 ) ))
tabs_list=($(bspc query -N -n .window -d focused))
tab_focus=$(bspc query -N -n .window.focused)
for tab_id in ${tabs_list[@]}; do
	tab_length=$(( ( $tabs_max - ( 2 * ${#tabs_list[@]} ) ) / ${#tabs_list[@]} ))
	[[ ! -z $tab_max ]] && [[ ${#tabs_list[@]} -gt 1 ]] && [[ $tab_length -gt $tab_max ]] \
		&& tab_length=$tab_max
	tab=$(xtitle $tab_id)
	if [[ ${#tab} -gt $tab_length ]]; then
		tab="${tab::(( $tab_length - 1 ))}â€¦"
		pad=
	else
		[[ ${#tabs_list[@]} -gt 1 ]] \
			&& pad=${pading::(( $tab_length - ${#tab} ))}
	fi
	if [[ $tab_id == $tab_focus ]]; then
		fg=$ffg
		bg=$fbg
	else
		fg=$nfg
		bg=$nbg
	fi
	tabs+="%{A1:xdo activate $tab_id: A2:bspc node $tab_id --kill: A3:bspc node $tab_id --close: F#00000000 B$bg}|%{F$fg}$tab%{F#00000000}$pad|%{F$nfg B$nbg A A A}"
	tabs_length=$(( $tabs_length + ${#tab} + ${#pad} + 2 ))
done
[[ -z $tabs_list ]] && tabs_length=0
tabs+=%{F#00000000}$pading
tabs=${tabs::(( ( ${#tabs} - ${#pading} ) + ( $tabs_max - $tabs_length ) + 3 ))}

echo $workspaces$tabs$other
# echo ${pading::$bar_max}


exit
